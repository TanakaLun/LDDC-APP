name: Build LDDC APK

on:
  push:
  workflow_dispatch:
    inputs:
      build_all:
        type: choice
        description: 'é€‰æ‹©ç¼–è¯‘ç±»åž‹'
        required: true
        default: 'both'
        options:
          - 'both'
          - 'debug'
          - 'release'
      custom_version_name:
        type: string
        description: 'è‡ªå®šä¹‰ç‰ˆæœ¬åç§°ï¼ˆå¯é€‰ï¼Œç•™ç©ºåˆ™ä½¿ç”¨çŸ­æäº¤å“ˆå¸Œï¼‰'
        required: false
        default: ''

permissions:
  contents: read
  actions: read

jobs:
  build-debug:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.build_all == 'both' || github.event.inputs.build_all == 'debug'
    outputs:
      build_timestamp: ${{ steps.build_info.outputs.build_timestamp }}
    env:
      NATIVE_TARGET: "arm64-v8a"
      BUILD_TYPE: "debug"
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–æ‰€æœ‰æäº¤åŽ†å²ï¼Œç”¨äºŽè®¡ç®—ç‰ˆæœ¬å·
      
      - name: ðŸ› ï¸ Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ðŸ’» Set up Android SDK and NDK
        uses: android-actions/setup-android@v3
      
      - name: âš™ï¸ Calculate Version Info
        id: version_info
        env:
          COMMIT_ID: ${{ github.sha }}
        run: |
          # èŽ·å–çŸ­æäº¤å“ˆå¸Œï¼ˆå‰7ä½ï¼‰
          COMMIT_ID_SHORT=${COMMIT_ID::7}
          echo "commit_short=$COMMIT_ID_SHORT" >> $GITHUB_OUTPUT
          
          # è®¡ç®—ç‰ˆæœ¬å·ï¼ˆæäº¤æ€»æ•°+1ï¼Œä»Ž2å¼€å§‹ï¼‰
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION_CODE=$((COMMIT_COUNT + 1))
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          
          # ç¡®å®šç‰ˆæœ¬åç§°
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.custom_version_name }}" ]]; then
            # æ‰‹åŠ¨è§¦å‘ä¸”æœ‰è‡ªå®šä¹‰ç‰ˆæœ¬åç§°
            VERSION_NAME="${{ github.event.inputs.custom_version_name }}"
            echo "Using custom version name: $VERSION_NAME"
          else
            # ä½¿ç”¨çŸ­æäº¤å“ˆå¸Œ
            VERSION_NAME="$COMMIT_ID_SHORT"
          fi
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          
          echo "Version Code: $VERSION_CODE"
          echo "Version Name: $VERSION_NAME"
      
      - name: ðŸ› ï¸ Modify Gradle Build File
        run: |
          # æŸ¥æ‰¾å¹¶ä¿®æ”¹ build.gradle.kts
          GRADLE_FILE="app/build.gradle.kts"
          
          echo "Found gradle file: $GRADLE_FILE"
            
          # å¤‡ä»½åŽŸå§‹æ–‡ä»¶
          cp "$GRADLE_FILE" "${GRADLE_FILE}.bak"
            
          # ä½¿ç”¨ sed æ›¿æ¢ versionCode å’Œ versionName
          # åŒ¹é…æ ¼å¼: versionCode 1 æˆ– versionCode = 1
          sed -i "s/versionCode\s*[0-9]*/versionCode ${{ steps.version_info.outputs.version_code }}/g" "$GRADLE_FILE"
            
          # åŒ¹é…æ ¼å¼: versionName "xxx" æˆ– versionName = "xxx"
          sed -i "s/versionName\s*\".*\"/versionName \"${{ steps.version_info.outputs.version_name }}\"/g" "$GRADLE_FILE"
            
          echo "Modified versionCode to: ${{ steps.version_info.outputs.version_code }}"
          echo "Modified versionName to: ${{ steps.version_info.outputs.version_name }}"
            
          # æ˜¾ç¤ºä¿®æ”¹åŽçš„ç›¸å…³è¡Œ
          echo "Modified lines:"
          grep -n "versionCode\|versionName" "$GRADLE_FILE" || true
      
      - name: âš™ï¸ Grant execute permission to gradlew
        run: chmod +x gradlew
      
      - name: ðŸ—ï¸ Build Debug APK
        run: ./gradlew assembleDebug
      
      - name: ðŸ“¦ Find APK file and rename
        id: build_info
        env:
          COMMIT_SHORT: ${{ steps.version_info.outputs.commit_short }}
          VERSION_CODE: ${{ steps.version_info.outputs.version_code }}
        run: |
          BUILD_TIMESTAMP=$(date +%s)
          echo "build_timestamp=$BUILD_TIMESTAMP" >> $GITHUB_OUTPUT

          ORIGINAL_APK_PATH=$(find ${{ github.workspace }}/app/build/outputs/apk/debug/ -name "*.apk" | head -n 1)
          NEW_APK_NAME="LDDC-${{ env.NATIVE_TARGET }}-${{ env.BUILD_TYPE }}-v${VERSION_CODE}-${COMMIT_SHORT}.apk"
          
          # é‡å‘½å APK æ–‡ä»¶
          NEW_APK_DIR=$(dirname "$ORIGINAL_APK_PATH")
          NEW_APK_PATH="$NEW_APK_DIR/$NEW_APK_NAME"
          mv "$ORIGINAL_APK_PATH" "$NEW_APK_PATH"
          echo "apk_path=$NEW_APK_PATH" >> $GITHUB_OUTPUT
          echo "Found and renamed APK to: $NEW_APK_PATH"
      
      - name: ðŸ“¤ Upload Debug APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LDDC-debug-v${{ steps.version_info.outputs.version_code }}
          path: ${{ steps.build_info.outputs.apk_path }}
          retention-days: 7

  build-release:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.build_all == 'both' || github.event.inputs.build_all == 'release'
    outputs:
      build_timestamp: ${{ steps.build_info.outputs.build_timestamp }}
    env:
      NATIVE_TARGET: "arm64-v8a"
      BUILD_TYPE: "release"
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–æ‰€æœ‰æäº¤åŽ†å²ï¼Œç”¨äºŽè®¡ç®—ç‰ˆæœ¬å·
      
      - name: ðŸ› ï¸ Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ðŸ’» Set up Android SDK and NDK
        uses: android-actions/setup-android@v3
      
      - name: âš™ï¸ Calculate Version Info
        id: version_info
        env:
          COMMIT_ID: ${{ github.sha }}
        run: |
          # èŽ·å–çŸ­æäº¤å“ˆå¸Œï¼ˆå‰7ä½ï¼‰
          COMMIT_ID_SHORT=${COMMIT_ID::7}
          echo "commit_short=$COMMIT_ID_SHORT" >> $GITHUB_OUTPUT
          
          # è®¡ç®—ç‰ˆæœ¬å·ï¼ˆæäº¤æ€»æ•°+1ï¼Œä»Ž2å¼€å§‹ï¼‰
          COMMIT_COUNT=$(git rev-list --count HEAD)
          VERSION_CODE=$((COMMIT_COUNT + 1))
          echo "version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          
          # ç¡®å®šç‰ˆæœ¬åç§°
          if [[ "${{ github.event_name }}" == "workflow_dispatch" && -n "${{ github.event.inputs.custom_version_name }}" ]]; then
            # æ‰‹åŠ¨è§¦å‘ä¸”æœ‰è‡ªå®šä¹‰ç‰ˆæœ¬åç§°
            VERSION_NAME="${{ github.event.inputs.custom_version_name }}"
            echo "Using custom version name: $VERSION_NAME"
          else
            # ä½¿ç”¨çŸ­æäº¤å“ˆå¸Œ
            VERSION_NAME="$COMMIT_ID_SHORT"
          fi
          echo "version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
          
          echo "Version Code: $VERSION_CODE"
          echo "Version Name: $VERSION_NAME"
      
      - name: ðŸ› ï¸ Modify Gradle Build File
        run: |
          # æŸ¥æ‰¾å¹¶ä¿®æ”¹ build.gradle.kts
          GRADLE_FILE="app/build.gradle.kts"
          
          echo "Found gradle file: $GRADLE_FILE"
            
          # å¤‡ä»½åŽŸå§‹æ–‡ä»¶
          cp "$GRADLE_FILE" "${GRADLE_FILE}.bak"
            
          # ä½¿ç”¨ sed æ›¿æ¢ versionCode å’Œ versionName
          # åŒ¹é…æ ¼å¼: versionCode 1 æˆ– versionCode = 1
          sed -i "s/versionCode\s*[0-9]*/versionCode ${{ steps.version_info.outputs.version_code }}/g" "$GRADLE_FILE"
            
          # åŒ¹é…æ ¼å¼: versionName "xxx" æˆ– versionName = "xxx"
          sed -i "s/versionName\s*\".*\"/versionName \"${{ steps.version_info.outputs.version_name }}\"/g" "$GRADLE_FILE"
            
          echo "Modified versionCode to: ${{ steps.version_info.outputs.version_code }}"
          echo "Modified versionName to: ${{ steps.version_info.outputs.version_name }}"
            
          # æ˜¾ç¤ºä¿®æ”¹åŽçš„ç›¸å…³è¡Œ
          echo "Modified lines:"
          grep -n "versionCode\|versionName" "$GRADLE_FILE" || true
      
      - name: âš™ï¸ Grant execute permission to gradlew
        run: chmod +x gradlew
      
      - name: ðŸ—ï¸ Build Release APK
        run: ./gradlew assembleRelease
      
      - name: ðŸ“¦ Find APK file and rename
        id: build_info
        env:
          COMMIT_SHORT: ${{ steps.version_info.outputs.commit_short }}
          VERSION_CODE: ${{ steps.version_info.outputs.version_code }}
        run: |
          BUILD_TIMESTAMP=$(date +%s)
          echo "build_timestamp=$BUILD_TIMESTAMP" >> $GITHUB_OUTPUT

          ORIGINAL_APK_PATH=$(find ${{ github.workspace }}/app/build/outputs/apk/release/ -name "*.apk" | head -n 1)
          NEW_APK_NAME="LDDC-${{ env.NATIVE_TARGET }}-${{ env.BUILD_TYPE }}-v${VERSION_CODE}-${COMMIT_SHORT}.apk"
          
          # é‡å‘½å APK æ–‡ä»¶
          NEW_APK_DIR=$(dirname "$ORIGINAL_APK_PATH")
          NEW_APK_PATH="$NEW_APK_DIR/$NEW_APK_NAME"
          mv "$ORIGINAL_APK_PATH" "$NEW_APK_PATH"
          echo "apk_path=$NEW_APK_PATH" >> $GITHUB_OUTPUT
          echo "Found and renamed APK to: $NEW_APK_PATH"
      
      - name: ðŸ“¤ Upload Release APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LDDC-release-v${{ steps.version_info.outputs.version_code }}
          path: ${{ steps.build_info.outputs.apk_path }}
          retention-days: 7