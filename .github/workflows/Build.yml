name: APK Build

on:
  push:
  workflow_dispatch:
    inputs:
      build_all:
        type: choice
        description: 'é€‰æ‹©ç¼–è¯‘ç±»åž‹'
        required: true
        default: 'both'
        options:
          - 'both'
          - 'debug'
          - 'release'

permissions:
  contents: read
  actions: read

jobs:
  build-debug:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.build_all == 'both' || github.event.inputs.build_all == 'debug'
    outputs:
      build_timestamp: ${{ steps.build_info.outputs.build_timestamp }}
    env:
      NATIVE_TARGET: "arm64-v8a"
      BUILD_TYPE: "debug"
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ› ï¸ Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ðŸ’» Set up Android SDK and NDK
        uses: android-actions/setup-android@v3
      
      - name: âš™ï¸ Grant execute permission to gradlew
        run: chmod +x gradlew
      
      - name: ðŸ—ï¸ Build Debug APK
        run: ./gradlew assembleDebug
      
      - name: ðŸ“¦ Find APK file and rename
        id: build_info
        env:
          COMMIT_ID: ${{ github.sha }}
        run: |
          BUILD_TIMESTAMP=$(date +%s)
          echo "build_timestamp=$BUILD_TIMESTAMP" >> $GITHUB_OUTPUT

          ORIGINAL_APK_PATH=$(find ${{ github.workspace }}/app/build/outputs/apk/debug/ -name "*.apk" | head -n 1)
          COMMIT_ID_SHORT=${COMMIT_ID::7}
          NEW_APK_NAME="LDDC-${{ env.NATIVE_TARGET }}-${{ env.BUILD_TYPE }}-${COMMIT_ID_SHORT}.apk"
          
          # é‡å‘½å APK æ–‡ä»¶
          NEW_APK_DIR=$(dirname "$ORIGINAL_APK_PATH")
          NEW_APK_PATH="$NEW_APK_DIR/$NEW_APK_NAME"
          mv "$ORIGINAL_APK_PATH" "$NEW_APK_PATH"
          echo "apk_path=$NEW_APK_PATH" >> $GITHUB_OUTPUT
          echo "Found and renamed APK to: $NEW_APK_PATH"
      
      - name: ðŸ“¤ Upload Debug APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LDDC-debug
          path: ${{ steps.build_info.outputs.apk_path }}
          retention-days: 7

  build-release:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || github.event.inputs.build_all == 'both' || github.event.inputs.build_all == 'release'
    outputs:
      build_timestamp: ${{ steps.build_info.outputs.build_timestamp }}
    env:
      NATIVE_TARGET: "arm64-v8a"
      BUILD_TYPE: "release"
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ðŸ› ï¸ Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: ðŸ’» Set up Android SDK and NDK
        uses: android-actions/setup-android@v3
      
      - name: âš™ï¸ Grant execute permission to gradlew
        run: chmod +x gradlew
      
      - name: ðŸ—ï¸ Build Release APK
        run: ./gradlew assembleRelease
      
      - name: ðŸ“¦ Find APK file and rename
        id: build_info
        env:
          COMMIT_ID: ${{ github.sha }}
        run: |
          BUILD_TIMESTAMP=$(date +%s)
          echo "build_timestamp=$BUILD_TIMESTAMP" >> $GITHUB_OUTPUT

          ORIGINAL_APK_PATH=$(find ${{ github.workspace }}/app/build/outputs/apk/release/ -name "*.apk" | head -n 1)
          COMMIT_ID_SHORT=${COMMIT_ID::7}
          NEW_APK_NAME="LDDC-${{ env.NATIVE_TARGET }}-${{ env.BUILD_TYPE }}-${COMMIT_ID_SHORT}.apk"
          
          # é‡å‘½å APK æ–‡ä»¶
          NEW_APK_DIR=$(dirname "$ORIGINAL_APK_PATH")
          NEW_APK_PATH="$NEW_APK_DIR/$NEW_APK_NAME"
          mv "$ORIGINAL_APK_PATH" "$NEW_APK_PATH"
          echo "apk_path=$NEW_APK_PATH" >> $GITHUB_OUTPUT
          echo "Found and renamed APK to: $NEW_APK_PATH"
      
      - name: ðŸ“¤ Upload Release APK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: LDDC-release
          path: ${{ steps.build_info.outputs.apk_path }}
          retention-days: 7